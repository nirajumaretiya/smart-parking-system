{% extends "base.html" %}

{% block content %}
<div class="min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-parking text-2xl text-blue-600 mr-2"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Smart Parking System</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="current-time">Loading...</span>
                    </div>
                    <a href="{{ url_for('logout') }}" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 pb-8 px-4 sm:px-6 lg:px-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-effect rounded-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-car text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Available Slots</p>
                        <p class="text-2xl font-semibold text-gray-800" id="available-slots">-</p>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Occupancy Rate</p>
                        <p class="text-2xl font-semibold text-gray-800" id="occupancy-rate">-</p>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Last Updated</p>
                        <p class="text-sm font-semibold text-gray-800" id="timestamp">-</p>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-temperature-high text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">System Status</p>
                        <p class="text-sm font-semibold text-gray-800" id="system-status">Online</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parking Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for i in range(4) %}
            <div class="glass-effect rounded-lg p-6 slot-card" id="slot-{{ i+1 }}">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="status-indicator bg-gray-300" id="status-indicator-{{ i+1 }}"></span>
                        <h3 class="text-lg font-medium text-gray-900">Slot {{ i+1 }}</h3>
                    </div>
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500 opacity-30" id="red-{{ i+1 }}"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500 opacity-30" id="green-{{ i+1 }}"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm font-medium text-gray-500" id="status-{{ i+1 }}">Checking...</p>
                    <div class="text-xs text-gray-400">
                        <p>Last Updated: <span id="slot-timestamp-{{ i+1 }}">-</span></p>
                        <p>Duration: <span id="slot-duration-{{ i+1 }}">-</span></p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- System Info -->
        <div class="mt-8 glass-effect rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">System Information</h3>
                    <p class="text-sm text-gray-500">Real-time monitoring and status updates</p>
                </div>
                <div class="flex space-x-4">
                    <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                    </button>
                    <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-download mr-2"></i>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Update current time
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleTimeString();
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

// Slot timestamps and durations
const slotTimestamps = {};
const slotDurations = {};

function updateStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update timestamp
            document.getElementById('timestamp').textContent = data.timestamp;
            
            // Calculate statistics
            let availableSlots = 0;
            let occupiedSlots = 0;
            
            // Update each slot
            data.slots.forEach(slot => {
                const slotId = slot.id;
                const redLed = document.getElementById(`red-${slotId}`);
                const greenLed = document.getElementById(`green-${slotId}`);
                const statusText = document.getElementById(`status-${slotId}`);
                const statusIndicator = document.getElementById(`status-indicator-${slotId}`);
                
                if (slot.occupied) {
                    occupiedSlots++;
                    redLed.classList.remove('opacity-30');
                    greenLed.classList.add('opacity-30');
                    statusText.textContent = 'Occupied';
                    statusText.classList.remove('text-green-600');
                    statusText.classList.add('text-red-600');
                    statusIndicator.classList.remove('bg-gray-300');
                    statusIndicator.classList.add('bg-red-500');
                    
                    // Update timestamp and duration
                    if (!slotTimestamps[slotId]) {
                        slotTimestamps[slotId] = new Date();
                    }
                    const duration = Math.floor((new Date() - slotTimestamps[slotId]) / 1000);
                    document.getElementById(`slot-timestamp-${slotId}`).textContent = 
                        slotTimestamps[slotId].toLocaleTimeString();
                    document.getElementById(`slot-duration-${slotId}`).textContent = 
                        `${Math.floor(duration / 60)}m ${duration % 60}s`;
                } else {
                    availableSlots++;
                    redLed.classList.add('opacity-30');
                    greenLed.classList.remove('opacity-30');
                    statusText.textContent = 'Available';
                    statusText.classList.remove('text-red-600');
                    statusText.classList.add('text-green-600');
                    statusIndicator.classList.remove('bg-red-500');
                    statusIndicator.classList.add('bg-gray-300');
                    
                    // Reset timestamp and duration
                    slotTimestamps[slotId] = null;
                    document.getElementById(`slot-timestamp-${slotId}`).textContent = '-';
                    document.getElementById(`slot-duration-${slotId}`).textContent = '-';
                }
            });
            
            // Update statistics
            document.getElementById('available-slots').textContent = availableSlots;
            const occupancyRate = ((occupiedSlots / 4) * 100).toFixed(1);
            document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('system-status').textContent = 'Offline';
            document.getElementById('system-status').classList.add('text-red-600');
        });
}

// Update status every second
setInterval(updateStatus, 1000);
updateStatus(); // Initial update
</script>
{% endblock %} 